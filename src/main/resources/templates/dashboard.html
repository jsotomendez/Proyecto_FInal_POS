<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/base :: main-layout(title='Dashboard', content=~{::#dash-content})}">
<body>
<div id="dash-content">
    <h2 class="mb-4">ðŸ“Š Tablero de Control</h2>
    <div class="row mb-4">
        <div class="col-md-3"><div class="card text-white bg-primary h-100"><div class="card-body"><h5>Ventas Hoy</h5><h2 th:text="${stats.totalVentasDia}">0</h2></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-success h-100"><div class="card-body"><h5>Ingresos</h5><h2 th:text="${'$ ' + stats.ingresosDia}">0</h2></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-danger h-100"><div class="card-body"><h5>Bajo Stock</h5><h2 th:text="${stats.productosBajoStock}">0</h2></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-info h-100"><div class="card-body"><h5>Clientes</h5><h2 th:text="${stats.clientesRegistrados}">0</h2></div></div></div>
    </div>
    <div class="row">
        <div class="col-md-8"><div class="card shadow"><div class="card-body"><canvas id="chartVentas"></canvas></div></div></div>
        <div class="col-md-4"><div class="card shadow"><div class="card-body"><canvas id="chartProductos"></canvas></div></div></div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Obtener datos de Java con seguridad (si es null, usa array vacÃ­o)
            var ventasDataRaw = /*[[${graficoVentas}]]*/ [];
            var productosDataRaw = /*[[${graficoProductos}]]*/ [];

            console.log("Datos Ventas:", ventasDataRaw); // Para depurar en consola
            console.log("Datos Productos:", productosDataRaw);

            // --- GRÃFICO DE VENTAS (LINEAL) ---
            var ctxVentas = document.getElementById('chartVentas');
            if (ctxVentas) {
                // Si no hay datos, ponemos valores por defecto para que se vea algo
                var fechas = ventasDataRaw.length ? ventasDataRaw.map(x => x[0]) : ["Sin datos"];
                var totales = ventasDataRaw.length ? ventasDataRaw.map(x => x[1]) : [0];

                // Invertimos para que salga cronolÃ³gico (de izquierda a derecha)
                if(ventasDataRaw.length) {
                    fechas = fechas.reverse();
                    totales = totales.reverse();
                }

                new Chart(ctxVentas, {
                    type: 'line',
                    data: {
                        labels: fechas,
                        datasets: [{
                            label: 'Ingresos ($)',
                            data: totales,
                            borderColor: '#e67e22', // Naranja corporativo
                            backgroundColor: 'rgba(230, 126, 34, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#2c3e50', // Azul corporativo
                            pointRadius: 4,
                            fill: true,
                            tension: 0.3 // Suavizado de curvas
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [5, 5] },
                                ticks: { callback: function(value) { return '$' + value; } }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // --- GRÃFICO DE PRODUCTOS (DONA) ---
            var ctxProductos = document.getElementById('chartProductos');
            if (ctxProductos) {
                var pNom = productosDataRaw.length ? productosDataRaw.map(x => x[0]) : ["Sin ventas"];
                var pCant = productosDataRaw.length ? productosDataRaw.map(x => x[1]) : [1]; // 1 ficticio para que se vea el cÃ­rculo gris
                var colores = productosDataRaw.length
                    ? ['#2c3e50', '#e67e22', '#16a085', '#c0392b', '#8e44ad'] // Colores reales
                    : ['#bdc3c7']; // Color gris si no hay datos

                new Chart(ctxProductos, {
                    type: 'doughnut',
                    data: {
                        labels: pNom,
                        datasets: [{
                            data: pCant,
                            backgroundColor: colores,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                        }
                    }
                });
            }
        });
        /*]]>*/
    </script>
</div>
</body>
</html>