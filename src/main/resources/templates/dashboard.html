<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/base :: main-layout(title='Dashboard Gerencial', content=~{::#dashboard-content})}">

<head><title>Ignorar</title></head>
<body>

<div id="dashboard-content">

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">游늵 Tablero de Control</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-success" onclick="exportarJson()">
                    <i class="bi bi-download"></i> Exportar JSON
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary shadow h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 opacity-75">Ventas Hoy</h6>
                            <h2 class="card-title display-6 fw-bold mb-0" th:text="${stats.totalVentasDia}">0</h2>
                        </div>
                        <i class="bi bi-cart-check fs-1 opacity-50"></i>
                    </div>
                    <small class="mt-2 d-block opacity-75">Pedidos procesados</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-success shadow h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 opacity-75">Ingresos Hoy</h6>
                            <h2 class="card-title display-6 fw-bold mb-0" th:text="${'$ ' + stats.ingresosDia}">$ 0</h2>
                        </div>
                        <i class="bi bi-currency-dollar fs-1 opacity-50"></i>
                    </div>
                    <small class="mt-2 d-block opacity-75">Facturaci칩n total</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-danger shadow h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 opacity-75">Bajo Stock</h6>
                            <h2 class="card-title display-6 fw-bold mb-0" th:text="${stats.productosBajoStock}">0</h2>
                        </div>
                        <i class="bi bi-exclamation-triangle fs-1 opacity-50"></i>
                    </div>
                    <small class="mt-2 d-block opacity-75">Productos cr칤ticos (< 10)</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-info shadow h-100 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 opacity-75">Clientes</h6>
                            <h2 class="card-title display-6 fw-bold mb-0" th:text="${stats.clientesRegistrados}">0</h2>
                        </div>
                        <i class="bi bi-people fs-1 opacity-50"></i>
                    </div>
                    <small class="mt-2 d-block opacity-75">Base de datos activa</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white border-bottom-0">
                    <h6 class="m-0 font-weight-bold text-primary">Tendencia de Ventas (칔ltimos 7 d칤as)</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartVentas" style="min-height: 500px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white border-bottom-0">
                    <h6 class="m-0 font-weight-bold text-primary">Top 5 Productos</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div style="width: 100%; max-width: 380px;">
                        <canvas id="chartProductos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script th:inline="javascript">
        /*<![CDATA[*/
        // Datos inyectados desde Java (se usan para gr치ficas y exportaci칩n)
        var ventasDataRaw = /*[[${graficoVentas}]]*/ [];
        var productosDataRaw = /*[[${graficoProductos}]]*/ [];
        var statsData = /*[[${stats}]]*/ {};

        // Procesar datos para Gr치ficas
        var fechas = ventasDataRaw.length ? ventasDataRaw.map(x => x[0]).reverse() : [];
        var totales = ventasDataRaw.length ? ventasDataRaw.map(x => x[1]).reverse() : [];
        var prodNombres = productosDataRaw.length ? productosDataRaw.map(x => x[0]) : [];
        var prodCantidades = productosDataRaw.length ? productosDataRaw.map(x => x[1]) : [];

        // 1. Gr치fico de L칤nea (Ventas)
        new Chart(document.getElementById('chartVentas'), {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Ingresos ($)',
                    data: totales,
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230, 126, 34, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#e67e22',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Gr치fico de Dona (Productos)
        new Chart(document.getElementById('chartProductos'), {
            type: 'doughnut',
            data: {
                labels: prodNombres,
                datasets: [{
                    data: prodCantidades,
                    backgroundColor: ['#2c3e50', '#e67e22', '#34495e', '#d35400', '#95a5a6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true } }
                }
            }
        });

        // 3. FUNCI칍N DE EXPORTACI칍N JSON
        function exportarJson() {
            // Construimos el objeto completo con la data actual
            const dataExport = {
                fechaReporte: new Date().toLocaleString(),
                indicadoresClave: {
                    ventasHoy: statsData.totalVentasDia,
                    ingresosHoy: statsData.ingresosDia,
                    alertasStock: statsData.productosBajoStock,
                    clientesTotales: statsData.clientesRegistrados
                },
                detalleVentasSemana: ventasDataRaw.map(v => ({ fecha: v[0], total: v[1] })),
                topProductos: productosDataRaw.map(p => ({ producto: p[0], cantidad: p[1] }))
            };

            // Convertir a texto JSON
            const jsonString = JSON.stringify(dataExport, null, 4);

            // Crear un "blob" (archivo virtual en memoria)
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            // Crear un link invisible y darle clic autom치ticamente
            const link = document.createElement("a");
            link.href = url;
            link.download = "reporte_dashboard_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        /*]]>*/
    </script>

</div>

</body>
</html>