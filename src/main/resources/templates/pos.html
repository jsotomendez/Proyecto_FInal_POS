<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/base :: main-layout(title='Punto de Venta', content=~{::#pos-content})}">
<head><title>Ignorar</title></head>
<body>

<div id="pos-content">

    <div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Finalizar Venta</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="cerrarModalPago()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="pagoPedidoId">
                    <div class="text-center mb-4">
                        <small class="text-muted">Total a Pagar</small>
                        <h1 class="fw-bold text-success" id="pagoTotalDisplay">$ 0.00</h1>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">M√©todo de Pago</label>
                        <select id="pagoMetodo" class="form-select form-select-lg">
                            <option value="EFECTIVO">üíµ Efectivo</option>
                            <option value="TARJETA">üí≥ Tarjeta D√©bito/Cr√©dito</option>
                            <option value="NEQUI">üì± Nequi / Daviplata</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Monto Recibido</label>
                        <input type="number" id="pagoMonto" class="form-control form-control-lg" placeholder="Ingrese valor">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalPago()">Cancelar</button>
                    <button type="button" class="btn btn-success px-4" onclick="procesarPago()">Confirmar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row h-100">
        <div class="col-md-4">
            <div class="card shadow-sm mb-3 border-0">
                <div class="card-header bg-primary text-white"><i class="bi bi-person-lines-fill"></i> Datos del Pedido</div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="small text-muted">Sede</label>
                            <select id="selectSede" class="form-select form-select-sm">
                                <option th:each="s : ${listaSedes}" th:value="${s.sedeId}" th:text="${s.nombre}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Servicio</label>
                            <select id="selectTipo" class="form-select form-select-sm">
                                <option value="MESA">Mesa</option>
                                <option value="DOMICILIO">Domicilio</option>
                                <option value="LLEVAR">Para Llevar</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="small text-muted">Cliente</label>
                            <select id="selectCliente" class="form-select">
                                <option th:each="c : ${listaClientes}" th:value="${c.clienteId}" th:text="${c.nombre}"></option>
                            </select>
                        </div>
                        <div class="col-md-12 mt-2">
                            <label class="small text-danger fw-bold"><i class="bi bi-ticket-perforated"></i> Promoci√≥n (Opcional)</label>
                            <select id="selectPromo" class="form-select border-danger">
                                <option value="">-- Ninguna --</option>
                                <option th:each="pro : ${listaPromociones}"
                                        th:value="${pro.promoId}"
                                        th:text="${pro.codigo + ' - ' + pro.descripcion}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white"><i class="bi bi-upc-scan"></i> Agregar Producto</div>
                <div class="card-body">
                    <div class="mb-3">
                        <select id="selectProducto" class="form-select form-select-lg">
                            <option value="">Buscar producto...</option>
                            <option th:each="p : ${listaProductos}"
                                    th:value="${p.productoId}"
                                    th:text="${p.nombre + ' ($' + p.precioBase + ')'}"
                                    th:data-precio="${p.precioBase}"
                                    th:data-nombre="${p.nombre}"></option>
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" id="inputCantidad" class="form-control" value="1" min="1" placeholder="Cant.">
                        </div>
                        <div class="col-6">
                            <button onclick="agregarAlCarrito()" class="btn btn-primary w-100"><i class="bi bi-plus-lg"></i> Agregar</button>
                        </div>
                    </div>
                    <input type="text" id="inputNotas" class="form-control mt-2 form-control-sm" placeholder="Notas (ej: Sin salsa)">
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-white border-bottom pt-3 pb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-cart3"></i> Carrito de Compras</h5>
                        <span class="badge bg-secondary" id="fechaHoy"></span>
                    </div>
                </div>

                <div class="card-body d-flex flex-column p-0">
                    <div class="table-responsive flex-grow-1 p-3" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Subtotal</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="tablaCarritoBody">
                            </tbody>
                        </table>

                        <div id="emptyCartMsg" class="text-center text-muted py-5">
                            <i class="bi bi-basket display-1 opacity-25"></i>
                            <p class="mt-3">El carrito est√° vac√≠o</p>
                        </div>
                    </div>

                    <div class="p-4 bg-light border-top">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="text-muted">Items: <span id="totalItems" class="fw-bold text-dark">0</span></h6>
                            </div>
                            <div class="col-md-6">
                                <div class="bg-dark text-white p-3 rounded text-end shadow-sm">
                                    <small class="d-block text-uppercase opacity-75" style="font-size: 0.7rem;">Total a Pagar</small>
                                    <span id="spanTotal" class="display-6 fw-bold" style="font-family: 'Courier New', monospace;">$ 0.00</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="finalizarVenta()" class="btn btn-success w-100 btn-lg mt-3 fw-bold shadow-sm">
                            COBRAR VENTA <i class="bi bi-arrow-right-circle-fill ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let carrito = [];
        let pedidoActualId = null;
        // Instancia del modal de Bootstrap (se inicializa cuando se necesita)
        let modalPagoBS = null;

        document.getElementById("fechaHoy").innerText = new Date().toLocaleDateString();

        function agregarAlCarrito() {
            const selectProd = document.getElementById("selectProducto");
            const cantidad = document.getElementById("inputCantidad").value;
            const notas = document.getElementById("inputNotas").value;

            if (selectProd.value === "" || cantidad <= 0) { alert("‚ö†Ô∏è Seleccione un producto y cantidad v√°lida."); return; }

            const id = selectProd.value;
            const nombre = selectProd.options[selectProd.selectedIndex].getAttribute("data-nombre");
            const precio = parseFloat(selectProd.options[selectProd.selectedIndex].getAttribute("data-precio"));

            carrito.push({
                productoId: parseInt(id),
                nombre: nombre,
                cantidad: parseInt(cantidad),
                precio: precio,
                subtotal: precio * cantidad,
                observaciones: notas
            });

            renderizarTabla();

            // Resetear campos
            document.getElementById("inputCantidad").value = "1";
            document.getElementById("inputNotas").value = "";
            selectProd.focus();
        }

        function renderizarTabla() {
            const tbody = document.getElementById("tablaCarritoBody");
            const emptyMsg = document.getElementById("emptyCartMsg");

            tbody.innerHTML = "";
            let totalGeneral = 0;
            let count = 0;

            if(carrito.length > 0) {
                emptyMsg.style.display = 'none';
                carrito.forEach((item, index) => {
                    totalGeneral += item.subtotal;
                    count += item.cantidad;
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <span class="fw-bold">${item.nombre}</span><br>
                                <small class="text-muted fst-italic">${item.observaciones}</small>
                            </td>
                            <td class="text-center"><span class="badge bg-light text-dark border">${item.cantidad}</span></td>
                            <td class="text-end">$${item.precio.toLocaleString()}</td>
                            <td class="text-end fw-bold">$${item.subtotal.toLocaleString()}</td>
                            <td class="text-end">
                                <button onclick="eliminarItem(${index})" class="btn btn-outline-danger btn-sm border-0">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            } else {
                emptyMsg.style.display = 'block';
            }

            document.getElementById("spanTotal").innerText = "$ " + totalGeneral.toLocaleString();
            document.getElementById("totalItems").innerText = count;
        }

        function eliminarItem(index) {
            carrito.splice(index, 1);
            renderizarTabla();
        }

        function finalizarVenta() {
            if (carrito.length === 0) { alert("‚ö†Ô∏è El carrito est√° vac√≠o."); return; }

            const pedidoDTO = {
                clienteId: parseInt(document.getElementById("selectCliente").value),
                sedeId: parseInt(document.getElementById("selectSede").value),
                tipo: document.getElementById("selectTipo").value,
                items: carrito
            };

            // Deshabilitar bot√≥n para evitar doble click
            const btn = document.querySelector("button[onclick='finalizarVenta()']");
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

            fetch('/api/pedidos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(pedidoDTO)
            })
                .then(r => r.ok ? r.json() : r.text().then(t => {throw new Error(t)}))
                .then(data => {
                    pedidoActualId = data.pedidoId;
                    // Prepara el modal
                    document.getElementById("pagoPedidoId").value = pedidoActualId;
                    document.getElementById("pagoTotalDisplay").innerText = "$ " + data.total.toLocaleString();
                    document.getElementById("pagoMonto").value = data.total;

                    // Muestra el modal
                    const modalElem = document.getElementById('modalPago');
                    modalPagoBS = new bootstrap.Modal(modalElem);
                    modalPagoBS.show();
                })
                .catch(e => {
                    alert("‚ùå Error al crear pedido: " + e.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'COBRAR VENTA <i class="bi bi-arrow-right-circle-fill ms-2"></i>';
                });
        }

        function procesarPago() {
            const pagoDTO = {
                pedidoId: pedidoActualId,
                monto: parseFloat(document.getElementById("pagoMonto").value),
                metodoPago: document.getElementById("pagoMetodo").value
            };

            fetch('/api/pagos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(pagoDTO)
            })
                .then(r => r.ok ? r.json() : r.text().then(t => {throw new Error(t)}))
                .then(factura => {
                    cerrarModalPago();
                    alert("‚úÖ ¬°Pago Exitoso! Factura N¬∞: " + factura.numeroFactura);
                    carrito = [];
                    renderizarTabla();
                    // Opcional: Recargar para limpiar todo
                    window.location.reload();
                })
                .catch(e => alert("‚ùå Error al procesar pago: " + e.message));
        }

        function cerrarModalPago() {
            if(modalPagoBS) modalPagoBS.hide();
        }

        function finalizarVenta() {
            if (carrito.length === 0) { alert("‚ö†Ô∏è El carrito est√° vac√≠o."); return; }

            const pedidoDTO = {
                // ... (tus datos del pedido) ...
                clienteId: parseInt(document.getElementById("selectCliente").value),
                sedeId: parseInt(document.getElementById("selectSede").value),
                tipo: document.getElementById("selectTipo").value,
                items: carrito
            };

            // Deshabilitar bot√≥n
            const btn = document.querySelector("button[onclick='finalizarVenta()']");
            const btnTextoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

            fetch('/api/pedidos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(pedidoDTO)
            })
                .then(async response => {
                    // Si la respuesta NO es OK (ej: error de stock 400), leemos el texto
                    if (!response.ok) {
                        const mensajeError = await response.text();
                        throw new Error(mensajeError); // Lanzamos el error con el texto limpio
                    }
                    return response.json(); // Si es OK, seguimos normal
                })
                .then(data => {
                    // ... (tu l√≥gica de √©xito) ...
                    pedidoActualId = data.pedidoId;
                    document.getElementById("pagoPedidoId").value = pedidoActualId;
                    document.getElementById("pagoTotalDisplay").innerText = "$ " + data.total.toLocaleString();
                    document.getElementById("pagoMonto").value = data.total;

                    const modalElem = document.getElementById('modalPago');
                    modalPagoBS = new bootstrap.Modal(modalElem);
                    modalPagoBS.show();
                })
                .catch(e => {
                    // AQU√ç SALDR√Å EL AVISO LIMPIO
                    alert(e.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = btnTextoOriginal;
                });
        }

    </script>
</div>

</body>
</html>